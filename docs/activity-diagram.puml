@startuml CallProcessingActivity
title Diagrama de Actividad - Procesamiento de Llamadas

start

:Worker inicia y busca jobs;

repeat
    :Buscar jobs pendientes en MongoDB;
    
    if (¿Job disponible?) then (sí)
        :Reservar job con findOneAndUpdate;
        :Incrementar attempts;
        :Asignar worker_id;
        
        :Seleccionar próximo teléfono;
        
        if (¿Teléfono disponible?) then (sí)
            :Mapear datos del job a variables Retell;
            :Generar timestamp Chile actual;
            
            :POST /v2/create-phone-call a Retell;
            
            if (¿Llamada creada exitosamente?) then (sí)
                :Guardar call_id en MongoDB;
                :Iniciar seguimiento (polling);
                
                repeat
                    :Esperar 15 segundos;
                    :GET /v2/get-call/{call_id};
                    :Extender lease del job;
                    
                    if (¿Status final?) then (sí)
                        :Extraer datos completos;
                        :Calcular duración y costos;
                        :Actualizar variables dinámicas;
                        
                        if (¿Llamada exitosa?) then (sí)
                            :Marcar job como 'done';
                            :Guardar resultado completo;
                        else (no)
                            :Programar reintento;
                            :Avanzar al siguiente teléfono;
                        endif
                        
                        break
                    else (no)
                        note right: Status: ongoing, ringing, etc.
                    endif
                    
                repeat while (Dentro del timeout de 10 min) is (sí)
                -> no;
                :Timeout alcanzado;
                :Marcar como fallido temporalmente;
                
            else (no)
                :Log error de API;
                :Avanzar al siguiente teléfono;
            endif
            
        else (no)
            :Marcar job como 'failed' (terminal);
            note right: No quedan teléfonos
        endif
        
    else (no)
        :Esperar 1-1.5 segundos;
        note right: Jitter aleatorio
    endif
    
repeat while (Sistema activo) is (sí)
-> no;

:Cerrar conexiones;
:Finalizar worker;

stop

@enduml